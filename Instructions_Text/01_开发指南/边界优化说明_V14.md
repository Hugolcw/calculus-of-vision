# 边界优化说明 (Bounds Optimization Notes)

## 优化目标
防止动画和字幕超出屏幕，同时**最小化对视觉效果的影响**，避免画面拥挤。

## 优化策略

### 1. 保守缩放策略
- **阈值机制**：只有超出 5% 以上才进行缩放
- **最小缩放限制**：缩放比例不低于 0.85，保证可读性
- **宽松边距**：使用 0.98 的缩放因子（仅留 2% 边距），而非 0.95

### 2. 智能字幕换行
- **宽松估算**：字符宽度估算增加 10% 容差，避免过早换行
- **行数限制**：最多 3 行，避免字幕区域占用过大
- **智能分割**：优先在标点符号处换行，保持语义完整
- **保守缩放**：只在明显超出（>5%）时才缩放字幕

### 3. 位置调整优化
- **容差机制**：允许元素轻微超出边界（0.2-0.3 单位）
- **最小移动**：只在明显超出时才调整位置，避免破坏原有布局
- **字幕保护**：确保内容不与字幕区域（Y=-3.2）重叠

### 4. 关键元素特殊处理
- **公式保护**：使用 `conservative=True` 参数，避免过度缩放数学公式
- **避免重复检查**：元素定位后再检查一次，而非多次检查
- **布局尊重**：尽量保持原有的布局设计和视觉层次

## 参数说明

### `ensure_safe_bounds()` 参数
```python
ensure_safe_bounds(
    mobject, 
    max_width=None,           # 最大宽度（默认使用 SAFE_RECT）
    max_height=None,          # 最大高度（默认使用 SAFE_RECT）
    scale_factor=0.98,        # 缩放因子（0.98 = 留 2% 边距）
    tolerance=0.1,            # 容差比例（已弃用，改用固定值）
    conservative=True         # 保守模式（只在明显超出时调整）
)
```

### 字幕管理器参数
- 字幕最大宽度：`SAFE_RECT["width"] - 0.6`（左右各留 0.3 边距）
- 字幕缩放阈值：超出 5% 以上才缩放
- 字幕最小缩放：0.8（保证可读性）
- 字幕最大行数：3 行

## 视觉效果保证

1. **可读性优先**：最小缩放比例确保文本和公式可读
2. **布局尊重**：只在必要时调整，避免破坏原有设计
3. **空间利用**：允许轻微超出，避免画面过于拥挤
4. **智能换行**：字幕换行保持语义完整，不随意截断

## 使用建议

### 对于长文本
- 自动换行和缩放已足够，通常不需要手动调整
- 如果文本过长（>50 字符），考虑简化文案

### 对于公式
- 使用 `conservative=True` 保护公式可读性
- 如果公式仍然过长，考虑拆分或使用更小的字号

### 对于复杂布局
- 对于已经精心设计的布局，使用容差机制允许轻微超出
- 只在明显超出屏幕时才进行调整

## 测试建议

1. 渲染完整视频，检查是否有元素被过度缩放
2. 检查字幕是否在合理行数内（≤3 行）
3. 验证公式和长文本的可读性
4. 确认布局没有被意外破坏

## 版本历史

- **V14.1**：初始优化版本
- **V14.2**：添加保守模式，改进字幕换行逻辑，增加容差机制

