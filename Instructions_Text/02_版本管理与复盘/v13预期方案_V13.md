# 📘 Project Sobel V13 深度实施手册 (Blueprint with Pathology Mapping)

**对应代码版本**：V13 (`sobel_v13_full.py`)  
**文档编号**：V13

 **总方针** ：单一信源 (Single Source of Truth) + 严苛的布局约束 (Strict Layout) + 电影级质感 (Cinematic Look)。

---

### 🏗️ 模块一：基础设施重构 (Infrastructure Refactor)

 **目标** ：构建一个“不允许丑陋发生”的代码环境。

#### 1.1 语义化色彩系统 (Semantic Palette)

不再使用 `RED`, `BLUE` 等物理颜色，而是基于**信息功能**定义颜色。

* **⚠️ 关联病历** ：
* **#1 (廉价感)** : 默认高饱和色导致视觉疲劳。
* **#6 (红线刺眼)** : 红色太像系统报错。
* **#14 (误差线撞色)** : 误差线与函数曲线颜色太近，看不清。
* **#16 (差分混淆)** : 三种差分方法颜色不统一，认知混乱。
* **🛠️ V13 实施方案 (`utils.py`)** ：
* 建立全局字典 `PALETTE`：
  **Python**

  ```
  PALETTE = {
      "BG_MAIN": "#0F1115",       # 深炭灰，解决 #1
      "MATH_FUNC": "#3498DB",     # 逻辑蓝 (函数本体)
      "MATH_ERROR": "#F1C40F",    # 琥珀金 (替代刺眼红)，解决 #6, #14
      "DIFF_FWD": "#E67E22",      # 前向色 (橙)，解决 #16
      "DIFF_BWD": "#E74C3C",      # 后向色 (柔和红)
      "DIFF_CTR": "#2ECC71",      # 中心色 (柔和绿)
      "HIGHLIGHT": "#FFFFFF"      # 绝对焦点
  }
  ```
* **强制规则** ：禁止在 Scene 代码中出现 `color=RED`，必须使用 `color=PALETTE["MATH_ERROR"]`。

#### 1.2 全局布局引擎 (Layout Engine)

建立坐标系宪法，设立“禁飞区”。

* **⚠️ 关联病历** ：
* **#1, #22 (安全区溢出)** : 画面元素被切边。
* **#2, #8, #24 (字幕遮挡)** : 字幕盖住坐标轴或演职员表。
* **#11 (文字重叠)** : 标注文字与算式打架。
* **#26 (左右互搏)** : Scene 3 中间文字挡住两边图像。
* **🛠️ V13 实施方案 (`utils.py` & BaseScene)** ：
* **定义常量** ：`SAFE_RECT` (w=13, h=7)，`SUBTITLE_Y = -3.2`。
* **Z轴分层管理** ：
  **Python**

    ``    Z_BG = -10      # 网格     Z_CONTENT = 0   # 图表     Z_FLOAT = 10    # 悬浮标注     Z_UI = 100      # 字幕 (永远在最上层)    ``

* **布局网格 (Grid System)** ：
  * 将 Scene 3 强制划分为 `LEFT_COL` (x=-3.5) 和 `RIGHT_COL` (x=3.5)，中间留出 `GUTTER = 1.0` 的缓冲区，物理隔离图文，解决  **#26** 。

#### 1.3 智能组件工厂 (Smart Components)

封装通用组件，统一视觉语言。

* **⚠️ 关联病历** ：
* **#4 (摩尔纹)** : 矩形拼接导致闪烁。
* **#9 (黑框遮挡)** : 粗暴的黑框挡住关键动画。
* **#12 (方框比例失调)** : 框大字小，粗糙。
* **#14, #17 (线条太细/波浪太乱)** : 视觉辨识度低。
* **🛠️ V13 实施方案 (`utils.py`)** ：
* `SmartBox(mobject)`: 自动计算 Padding (文字=0.15, 图=0.3)，统一圆角，解决  **#12** 。
* `FocusArrow(target)`: 替代黑框，从侧面指入，带呼吸效果，解决  **#9** 。
* `NeonLine(points)`: 自带 `stroke_width=4` 和微弱 `shadow`，解决  **#14** 。
* `CleanImage(array)`: 封装 `ImageMobject` 的抗锯齿设置，解决  **#4** 。

---

### 🧠 模块二：核心逻辑架构 (Core Logic Architecture)

 **目标** ：逻辑闭环，杜绝 Bug 和歧义。

#### 2.1 生命周期管理 (Lifecycle Hooks)

严格的“垃圾回收”机制。

* **⚠️ 关联病历** ：
* **#13 (幽灵红叉)** : 上一幕元素残留，严重 Bug。
* **#22 (转场遮挡)** : 新旧图像叠加混乱。
* **🛠️ V13 实施方案 (BaseScene)** ：
* 每个场景结束前，必须执行 `self.clear_scene()`。
* **组管理** ：
  **Python**

    ``    self.math_group = VGroup() # 所有数学对象扔这里     self.ui_group = VGroup()   # 所有 UI 对象扔这里     # 转场时     self.play(FadeOut(self.math_group), FadeOut(self.ui_group))    ``

#### 2.2 单一信源驱动 (Single Source of Truth)

用数据驱动视图，确保逻辑同步。

* **⚠️ 关联病历** ：
* **#10 (公式堆砌)** : 静态文本像 PPT，且信息过载。
* **#18 (数值跳动)** : 计算太快看不清。
* **#27 (逻辑冲突 - 关键)** : 扫描框向上走，图表向下走，教学事故。
* **🛠️ V13 实施方案** ：
* **Scene 1.5** : 定义一个 `dx_tracker = ValueTracker(1.0)`。右侧的公式文本、左侧的切线斜率，全部用 `always_redraw` 绑定这个 tracker。
* **Scene 4 (修复 #27)** :
  * 定义主逻辑函数 `get_scan_data(t) -> (pos_3d, derivative_value)`。
  * 3D 扫描框位置 = `pos_3d`。
  * 2D 示波器点位置 = `(t, derivative_value)`。
  *  **强制同步** ：绝不分开写两个动画，确保“看见的”就是“算出来的”。

---

### 🎨 模块三：视觉叙事策略 (Visual Storytelling)

 **目标** ：引导观众视线，提升“高级感”。

#### 3.1 视觉层级控制 (Focus & Hierarchy)

不是所有东西都要亮着。

* **⚠️ 关联病历** ：
* **#15 (公式拖沓)** : 逐字写公式太慢，且与图形无联系。
* **#19 (结果过暗)** : 边缘检测结果看不清。
* **🛠️ V13 实施方案** ：
* **聚光灯模式** ：当讲解 **$f''(x)$** 时，背景函数曲线 `opacity` 降至 0.2，只高亮误差线段。
* **视觉桥梁** ：使用 `TransformFromCopy`，让公式里的项“飞”到图像上变成线段，建立强连接（修复  **#15** ）。
* **亮度补偿** ：在 Scene 3 结果填充时，应用 `gamma_correction` 或手动提升暗部亮度（修复  **#19** ）。

#### 3.2 动效质感与节奏 (Motion & Rhythm)

拒绝机器人式的匀速运动。

* **⚠️ 关联病历** ：
* **#5 (转场生硬)** : 图片切换没过渡。
* **#7 (动画生硬)** : 缺乏呼吸感。
* **#18 (滑动匀速)** : 像流水线。
* **🛠️ V13 实施方案** ：
* **非线性运动** ：
  * 卷积窗口滑动：使用 `rate_func=there_and_back` 的变体，模拟“吸附”在特征点上的感觉。
* **呼吸感** ：给所有静态停留超过 3秒 的核心元素（如最终公式）加上 `add_updater(wiggling)`。
* **变形转场** ：Scene 0 到 Scene 1，尝试让噪点“汇聚”成坐标轴，而不是简单的 FadeOut/In（修复  **#5** ）。

#### 3.3 真实感增强 (Reality Rendering)

拒绝低幼像素风。

* **⚠️ 关联病历** ：
* **#21 (假照片)** : 10x10 方块太假。
* **#23 (矩阵模糊)** : 缩放过度导致线条糊。
* **🛠️ V13 实施方案** ：
* **高清重制** ：Scene 4.5 使用 100x100 的 `ImageMobject` 配合 `nearest` 插值，模拟像素艺术风格但保持高精细度。
* **矢量重绘** ：Scene 5 的回顾矩阵，不要缩放旧对象，而是新建一个专门针对小尺寸优化的 `Matrix` 对象（修复  **#23** ）。

---

执行建议：

建议你打印这份手册，在写代码时，每完成一个子模块，就划掉对应的“病历号”。这不仅能确保没有遗漏，还会带来极大的心理满足感——因为你在亲手消灭那些曾经困扰你的 Bug。

准备好开始“根治”行动了吗？
