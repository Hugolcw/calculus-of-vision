
---

### 📂 模块一：全局配置与语义定义 (Config & Semantics)

**目的：** 建立视觉规范，确保全片色彩和风格的统一性，降低观众的认知负荷。

* **1.1 颜色语义池 (Semantic Color Pool)**
  * 定义 `COLOR_CONTINUOUS`: 代表理想数学（如 `BLUE`）。
  * 定义 `COLOR_DISCRETE`: 代表工程采样（如 `YELLOW`）。
  * 定义 `COLOR_DIFF`: 代表微分/变化/高频（如 `RED`）。
  * 定义 `COLOR_SMOOTH`: 代表平滑/保持/低频（如 `TEAL`）。
  * 定义 `COLOR_GHOST`: 代表过去的影子（低透明度的灰色）。
* **1.2 排版规范 (Typography)**
  * 指定 LaTeX 模板（使用 `TexTemplate` 引入 `amsmath` 以支持矩阵）。
  * 统一字体大小：公式字号 vs 说明文字字号。
* **1.3 全局工具函数 (Helpers)**
  * `get_downsampled_array(image, rate)`:  **核心工程函数** 。输入图片路径，返回降采样后的 Numpy 数组。防止 Scene 4 渲染爆炸。

---

### 🎬 模块二：主场景类结构 (Main Scene Structure)

类名： class SobelUniverse(ThreeDScene):

继承关系： 必须继承 ThreeDScene，因为 Scene 4 需要相机移动。

* **`def construct(self):` (总导演)**
  * **功能：** 按顺序调度各个子场景函数。
  * **开发技巧：** 使用注释掉的方式（`#`）来单独测试某一部分，例如只运行 `self.scene_4_vision()`。

---

### 🎬 模块三：Scene 1 - 离散现实 (Discrete Reality)

函数名： setup_scene_1_discrete()

核心逻辑： 视觉对比与采样定理的隐喻。

1. **对象初始化 (Objects):**
   * `axes`: 坐标轴（低透明度，不要抢戏）。
   * `func_continuous`: `FunctionGraph` 对象，绘制平滑的正弦组合曲线。
   * `tangent_tracker`: `ValueTracker`，用于控制切线位置。
   * `tangent_line`: `always_redraw` 更新的切线。
2. **动画流程 (Animations):**
   * **Act 1: 理想展示** -> `Create` 曲线，`tracker` 变动带动切线滑动。
   * **Act 2: 幽灵变换 (关键体验)** ->
     * 复制 `func_continuous` 为 `ghost_graph`。
     * `func_continuous` 透明度设为 0（或淡出）。
     * `ghost_graph` 透明度设为 0.2（作为背景保留）。
     * `Create` 离散柱状图 (`VGroup` of Lines/Dots)，位置由 `np.linspace` 计算，严格对齐曲线。
   * **Act 3: 聚焦困境** -> 相机 `frame.animate.scale(0.3).move_to(...)` 推进到特定采样点，展示问号。

---

### 🎬 模块四：Scene 2 - 泰勒桥梁 (The Taylor Bridge)

函数名： setup_scene_2_taylor()

核心逻辑： 节奏控制与公式消消乐。

1. **对象初始化 (Objects):**
   * `taylor_forward`: `MathTex`，展开式 **$f(x+1)$**。**关键：** 使用 `substrings_to_isolate` 参数分离出 **$f(x)$**, **$f'(x)$** 等项。
   * `taylor_backward`: `MathTex`，展开式 **$f(x-1)$**。
   * `parabolas`: 虚线抛物线，辅助说明这是“局部近似”。
2. **动画流程 (Animations):**
   * **Act 1: 分步揭示** -> 使用 `Write` 配合 `lag_ratio` 逐项写出公式，避免信息过载。
   * **Act 2: 视觉对撞 (关键体验)** ->
     * 选中两个公式中相同的项（偶数阶项）。
     * `animate.set_color(COLOR_DIFF)` 变红预警。
     * `Wait(0.5)`  **停顿** （给观众反应时间）。
     * `FadeOut` 消除项，配合音效占位符。
   * **Act 3: 算子结晶** -> 剩余的项变形 (`TransformMatchingTex`) 为最终差分公式，然后数字 `-1, 0, 1` 飞出排列成向量。

---

### 🎬 模块五：Scene 3 - 算子解构 (Operator Anatomy)

函数名： setup_scene_3_matrices()

核心逻辑： 颜色编码与矩阵广播。

1. **对象初始化 (Objects):**
   * `kernel_x`: 行向量 `Matrix`，设置为 `COLOR_DIFF` (红)。
   * `kernel_y`: 列向量 `Matrix`，设置为 `COLOR_SMOOTH` (绿/青)。
   * `kernel_sobel`: 最终的 3x3 `IntegerMatrix`。
2. **动画流程 (Animations):**
   * **Act 1: 身份确认** -> 展示两个向量，并用 `Brace` 标注功能（微分 vs 平滑）。
   * **Act 2: 外积演示** ->
     * 移动两个向量使其垂直对齐（以此暗示乘法）。
     * 演示“广播”过程：行向量扫过列向量，生成网格。
     * `Transform` 为最终的 3x3 矩阵，颜色融合（如金色）。
   * **Act 3: 结构高亮** -> 使用 `SurroundingRectangle` 快速闪烁矩阵的边缘和中心，强调结构。

---

### 🎬 模块六：Scene 4 - 维度跃迁 (Dimensional Leap)

函数名： setup_scene_4_vision()

核心逻辑： 空间认知引导与性能优化。

1. **数据准备 (Data Prep - 最重要的一步):**
   * 加载图片 -> `get_pixel_array()`。
   * **降采样处理** -> `array[::10, ::10]`。如果不做这步，Manim 会卡死。
2. **对象初始化 (Objects):**
   * `image_plane`: 2D 图片对象。
   * `scan_line`: 2D 扫描线。
   * `waveform`: 基于图片某一行数据生成的 `FunctionGraph`。
   * `terrain_surface`: 基于降采样数据生成的 `Surface` (3D)。
3. **动画流程 (Animations):**
   * **Act 1: 2D 锚定 (关键体验)** -> 保持默认相机视角。扫描线扫过图片，并在侧边同步画出 `waveform` 波形。**目的：** 告诉观众“亮度=高度”。
   * **Act 2: 维度切换** ->
     * `self.move_camera(phi=75*DEGREES, theta=...)`。
     * 在相机旋转的同时，图片 `Transform` 为 `terrain_surface`。
   * **Act 3: 全息扫描** -> 一个发光的方框（代表算子）在 3D 地形上移动。
   * **Act 4: 特征图生成** -> 3D 地形压扁/淡出，显现出黑白边缘检测图（Canny/Sobel图）。

---

### 🎬 模块七：Outro - 知行合一

函数名： setup_scene_5_outro()

核心逻辑： 情感共鸣与合规。

1. **对象初始化:**
   * `recap_group`: 之前场景的关键元素复用（泰勒公式、Sobel矩阵、正弦波）。
   * `credits_text`: 包含原创声明、工具列表的 `Tex` 对象。
2. **动画流程:**
   * **Act 1: 时光倒流** -> `AnimationGroup(..., lag_ratio=0.1)` 快速倒放之前的关键镜头。
   * **Act 2: 旁白升华** -> 屏幕留黑，只显示“知行合一”四个字或核心金句。
   * **Act 3: 版权页** -> 淡入字幕。

---

### 💡 这里的“坑”在哪里？(Director's Technical Warnings)

在开始写代码前，请特别注意这几个 **实现难点** ：

1. **坐标系对齐：** Scene 4 中，2D 图片的坐标 (`image.get_center()`) 和 3D Surface 的坐标系 (`axes.c2p`) 往往不重合。你需要仔细调试 `Surface` 的 `u_range` 和 `v_range` 参数，确保地形是正好从图片位置“长”出来的，而不是在屏幕另一个角落。
2. **Surface 的着色：** 默认的 Surface 颜色可能很丑。建议编写一个自定义的 `fill_color` 函数，让低处（黑色像素）显示蓝色/紫色，高处（白色像素）显示青色/白色，增强赛博朋克感。
3. **MathTex 的拆分：** 泰勒公式中有复杂的上下标。使用 `substrings_to_isolate` 时，有时 LaTeX 的渲染逻辑会把 `f'(x)` 视为一个整体，有时分开。建议先用 `index_labels()` 调试一下下标。
